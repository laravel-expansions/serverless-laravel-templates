#!/usr/bin/bash

ROOT_PATH=$(pwd)
PACKAGE_PATH=$ROOT_PATH/node_modules/serverless-laravel-templates

read -p "App Name [sam-app]: " name
APP_NAME=${name:-sam-app}


PS3='Please Select Template Number: '
select TEMPLETE_TYPE in "SAM Default Template" "SAM Default Template + Kinesis Trigger"
do
  if [ -n "$TEMPLETE_TYPE" ]; then
    break
  else
    echo 'invvalid value, input again.'
    echo
  fi
done
echo "> $TEMPLETE_TYPE"

echo

echo "| Template Result:"
echo "|"
echo "|  App Name: $APP_NAME"
echo "|  Template Type: $TEMPLETE_TYPE"
echo

read -p "Create this appï¼Ÿ (y/n) :" yn
YN=${yn:-y}

if [ "${YN}" = "y" ]; then
  echo
else
  echo
  echo "Aborted!"
  exit 0
fi

if [ "$TEMPLETE_TYPE" == "SAM Default Template" ]; then
  mkdir $ROOT_PATH/$APP_NAME
  cd $ROOT_PATH/$APP_NAME
  composer create-project laravel/laravel:^8.0 laravel
  cd $ROOT_PATH/$APP_NAME/laravel
  composer require bref/bref bref/laravel-bridge --update-with-dependencies

  cp $PACKAGE_PATH/src/Makefile $ROOT_PATH/$APP_NAME/laravel/Makefile
  cp $PACKAGE_PATH/templates/sam.default.template.yaml $ROOT_PATH/$APP_NAME/template.yaml
fi

if [ "$TEMPLETE_TYPE" == "SAM Default Template + Kinesis Trigger" ]; then
  mkdir $ROOT_PATH/$APP_NAME
  cd $ROOT_PATH/$APP_NAME
  composer create-project laravel/laravel:^8.0 laravel
  cd $ROOT_PATH/$APP_NAME/laravel
  composer require bref/bref bref/laravel-bridge --update-with-dependencies
  composer require laravel-expansions/serverless-function
  php artisan vendor:publish --tag=expantion-function

  cp $PACKAGE_PATH/src/Makefile $ROOT_PATH/$APP_NAME/laravel/Makefile
  cp $PACKAGE_PATH/templates/sam.kinesis.template.yaml $ROOT_PATH/$APP_NAME/template.yaml
fi

exit 0